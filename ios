var MongoClient = require("mongodb").MongoClient;
//var fs = require("fs");

var totalDocs = 568082642;

var average = {
	"number_of_docs": 0,
	"price" : 0,
	"rating" : 0,
	"timestamp" : 0,
};
var average_permissions = {
	"number_of_docs": 0,
	"price" : 0,
	"rating" : 0,
	"timestamp" : 0,
};
var average_no_permissions = {
	"number_of_docs": 0,
	"price" : 0,
	"rating" : 0,
	"timestamp" : 0,
};


MongoClient.connect("mongodb://migmongo1.stanford.edu:27017/apple_ios", function(err, db)
{
	if (err)
	{
		console.log("cannot connect");
		throw err;
	}
	console.log("connected to database");
	ios = db.collection("main");

	var size = 50

	var cursor = ios.find({}, ["app_name", 	"price", "timestamp", "ratingCountList", "hasInAppPurchases", "supportsPassbook"]).limit(200).batchSize(200);
	
	var i = 0;
	var count = 0;
	cursor.each(function(err, doc) {
		count++;
		//will make us ignore the last document in the cursor, but that is ok.
		if (count == totalDocs)
		{
			db.close();
			return;
		}
		if (doc == null)
		{
			db.close();
			return;
		}
		if (err)
		{
			console.log("ERROR");
			db.close();
			throw err;
		}
		if (i === 0) 
		{
			recordObject(doc);
			console.log(doc);
			console.log("\n\n");
			console.log(price_value(doc["price"]))
		}

		//use this to control how large a sample size you want.
		i = (i+1)%size;
	});

});


var recordObject = function(doc) {
	if (doc == null)
	{
		return;
	}

	record_general(doc);

	//then record to "yes permissions" or "no permissions" csv files
	if ("hasInAppPurchases" in doc)
	{
		record_permissions(doc);
	}
	else 
	{
		record_no_permissions(doc);
	}

};

var record_general = function(doc) {
	//doc guaranteed to not be null


	//include in general average
};
var record_permissions = function(doc) {
	//doc guaranteed to not be null

	//include in permissions average
};
var record_no_permissions = function(doc) {
	//doc guaranteed to not be null

	//include in no permissions average
};



var price_value = function(str) {
	return parseFloat(str.substring(1));
};
var average_rating = function(ratings) {
	var sum = 0;
	var i = 0;
	for (var rating in ratings) {
		sum +=- parseFloat(rating);
		i++;
	}
	return (sum/i);
}



